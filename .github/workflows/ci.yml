name: ci

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ci-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:

  auto_version_bump:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure branch is up to date with main
        run: |
          git fetch origin main --depth=1
          if ! git merge-base --is-ancestor origin/main HEAD; then
            echo "::error::This branch is behind main. Please rebase or merge the latest main, then push again."
            exit 1
          fi
          BASE_VERSION=$(git show origin/main:package.json | jq -r .version)
          echo "BASELINE_VERSION=${BASE_VERSION}" >> "$GITHUB_ENV"

      - name: Auto bump patch version and rename release notes
        run: |
          CURRENT_VERSION=$(jq -r .version package.json)
          echo "Current PR version: ${CURRENT_VERSION}"
          echo "Baseline (main) version: ${BASELINE_VERSION}"

          NEW_VERSION=$(node - <<'EOF'
            const fs = require('fs');
            const base = process.env.BASELINE_VERSION;
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const current = pkg.version;

            const parse = (v) => v.split('.').map(Number);
            const cmp = (a, b) => {
              for (let i = 0; i < Math.max(a.length, b.length); i += 1) {
                const left = a[i] ?? 0;
                const right = b[i] ?? 0;
                if (left !== right) return left - right;
              }
              return 0;
            };

            if (!base) {
              console.error('Missing BASELINE_VERSION');
              process.exit(1);
            }

            const baseParts = parse(base);
            const currParts = parse(current);

            const ordering = cmp(currParts, baseParts);

            // If PR version is already ahead of main, keep it (no bump)
            if (ordering > 0) {
              console.log(current);
              process.exit(0);
            }

            // If PR version is below main, fail with guidance
            if (ordering < 0) {
              console.error(`PR version ${current} is below main ${base}. Please set package.json version back to ${base} (or above) and push again.`);
              process.exit(1);
            }

            // current == base â†’ bump patch
            const nextParts = [...baseParts];
            nextParts[2] = (nextParts[2] ?? 0) + 1;
            const next = nextParts.join('.');

            pkg.version = next;
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log(next);
          EOF
          )

          if [ -z "${NEW_VERSION}" ]; then
            echo "::error::Failed to compute new version."
            exit 1
          fi

          echo "New version (after bump logic): ${NEW_VERSION}"

          if [ "${NEW_VERSION}" = "${CURRENT_VERSION}" ]; then
            echo "Version already ahead of main, no bump or rename needed."
            exit 0
          fi

          OLD_NOTES_FILE="docs/release_notes/${CURRENT_VERSION}.md"
          NEW_NOTES_FILE="docs/release_notes/${NEW_VERSION}.md"

          if [ -f "${OLD_NOTES_FILE}" ] && [ ! -f "${NEW_NOTES_FILE}" ]; then
            echo "Renaming release notes ${OLD_NOTES_FILE} -> ${NEW_NOTES_FILE}"
            git mv "${OLD_NOTES_FILE}" "${NEW_NOTES_FILE}"
          elif [ -f "${NEW_NOTES_FILE}" ]; then
            echo "Release notes file for ${NEW_VERSION} already exists at ${NEW_NOTES_FILE}, leaving as is."
          else
            echo "No existing release-notes file for ${CURRENT_VERSION}, creating stub for ${NEW_VERSION}."
            mkdir -p "$(dirname "${NEW_NOTES_FILE}")"
            {
              echo "# Release notes for ${NEW_VERSION}"
              echo
              echo "- TODO: Describe changes included in this release."
            } > "${NEW_NOTES_FILE}"
          fi

          if git diff --quiet -- package.json docs/release_notes/; then
            echo "::error::Expected version bump or release-notes change, but no changes were detected."
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json docs/release_notes/
          git commit -m "chore: auto bump version to ${NEW_VERSION} [auto-bump]"
          git push origin HEAD:${{ github.head_ref }}

  release_notes_check:
    needs: auto_version_bump
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check release notes
        id: check
        uses: ./.github/actions/release_notes_check
        with:
          version_file: 'package.json'
          notes_dir: 'docs/release_notes'
          notes_ext: '.md'

  sonarqube:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # Disabling shallow clone is recommended for improving relevancy of reporting
          fetch-depth: 0
      - name: sonarqube-scan-pullrequest
        uses: sonarsource/sonarqube-scan-action@master
        if: ${{ github.base_ref == 'main' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.pullrequest.key=${{ github.event.number }}
            -Dsonar.pullrequest.branch=${{ github.event.pull_request.head.ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.qualitygate.wait=true
            -Dsonar.qualitygate.timeout=1000

  lint:
    if: github.event.pull_request.state == 'open' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (app)
        uses: actions/checkout@v3
        with:
          path: app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'app/.nvmrc'
          cache: 'yarn'
          cache-dependency-path: 'app/yarn.lock'

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        working-directory: app
        run: yarn install --frozen-lockfile

      - name: Run lint
        working-directory: app
        run: yarn lint
